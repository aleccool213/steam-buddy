// Generated by CoffeeScript 1.9.3
(function() {
  var $q, PLAYER_SUMMARY_URL, Parser, SlackIntegration, User, async, config, getOnlineUsers, http, init, integrations, isUserOnline, parseUsers, parser, request, sendNotifications;

  request = require('request');

  http = require('http');

  Parser = require('./parser.js');

  config = require('../../config.json');

  parser = new Parser();

  SlackIntegration = require('./integrations/slack_integration.js');

  User = require('./user.js');

  $q = require('Q');

  async = require('async');

  PLAYER_SUMMARY_URL = process.env.PLAYER_SUMMARY_URL;

  integrations = [];

  init = function() {
    var id, minutes, the_interval, user, usersToCheck;
    integrations.push(new SlackIntegration({
      token: process.env.SLACK_TOKEN
    }));
    usersToCheck = [];
    usersToCheck = (function() {
      var ref, results;
      ref = config.users;
      results = [];
      for (id in ref) {
        user = ref[id];
        results.push(new User({
          name: user,
          id: id
        }));
      }
      return results;
    })();
    minutes = .1;
    the_interval = minutes * 60 * 1000;
    return setInterval(((function(_this) {
      return function() {
        return getOnlineUsers(usersToCheck);
      };
    })(this)), the_interval);
  };

  sendNotifications = function(user) {
    var i, integration, len, results;
    results = [];
    for (i = 0, len = integrations.length; i < len; i++) {
      integration = integrations[i];
      results.push(integration.sendNotification(user.name, user.currentGame));
    }
    return results;
  };

  parseUsers = function(usersToCheck) {
    var id, ref, user;
    ref = config.users;
    for (id in ref) {
      user = ref[id];
      usersToCheck.push(new User({
        name: user,
        id: id
      }));
    }
    return usersToCheck;
  };

  getOnlineUsers = function(allUsers) {
    var deferred, onlineUsers;
    onlineUsers = [];
    deferred = $q.defer();
    async.each(allUsers, function(user, callback) {
      return isUserOnline(user).then(function(result) {
        if (result) {
          onlineUsers.push(result);
        }
        return callback();
      });
    }, function(err) {
      var i, len, user;
      if (!err) {
        for (i = 0, len = onlineUsers.length; i < len; i++) {
          user = onlineUsers[i];
          sendNotifications(user);
        }
      }
      if (!err) {
        return deferred.resolve(onlineUsers);
      }
    });
    return deferred.promise;
  };

  isUserOnline = function(user) {
    var deferred, url;
    url = PLAYER_SUMMARY_URL + user.id;
    deferred = $q.defer();
    request(url, function(error, response, body) {
      var game, parsedResult, player;
      if (!error && response.statusCode === 200) {
        parsedResult = JSON.parse(body);
        player = parsedResult.response.players[0];
        if (!player) {
          return null;
        }
        game = player.gameextrainfo;
        if (game && !user.isPlaying()) {
          user.setInGame(game);
          return deferred.resolve(user);
        } else if (!game) {
          user.setInactive();
          return deferred.resolve(null);
        }
      } else {
        console.log('An error was encountered', error);
        return error;
      }
    });
    return deferred.promise;
  };

  init();

}).call(this);
